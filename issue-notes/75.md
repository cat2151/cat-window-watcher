# issue PR 74 を参考に、スクリーンセーバー認識がなぜ失敗しているか調査を進める #75
[issues #75](https://github.com/cat2151/cat-window-watcher/issues/75)

## 調査概要

PR #74で追加された`debug_screensaver_detection`機能を活用し、Windowsスクリーンセーバー認識が失敗している原因を調査する。

## 背景

- Issue #73: Windowsスクリーンセーバー時にスコアが増減しないようにする機能が失敗している
- PR #74: デバッグ機能を追加し、スクリーンセーバー検出の診断情報を出力できるようにした
- 報告されている問題:
  - Windowsスクリーンセーバーが空のウィンドウタイトルで表示される
  - スクリーンセーバーがスクリーンセーバーだと認識されない

## 現在の検出ロジック分析

### Windows版の検出方法

現在の`window_monitor.py`のWindows用スクリーンセーバー検出は以下の2段階:

1. **win32gui使用時**: 
   - `GetForegroundWindow()`でアクティブウィンドウのハンドルを取得
   - `GetClassName()`でウィンドウクラス名を取得
   - クラス名に"screensaver"が含まれているかチェック
   - 問題: 全てのスクリーンセーバーが"WindowsScreenSaverClass"を使用するとは限らない

2. **PowerShellフォールバック**:
   - `SystemParametersInfo(SPI_GETSCREENSAVERRUNNING, 0x0072)`を使用
   - 問題: このAPIは必ずしも正確ではない可能性がある

### 検出失敗の可能性のある原因

1. **クラス名の不一致**
   - 最近のWindowsバージョンやカスタムスクリーンセーバーが異なるクラス名を使用している可能性
   
2. **ウィンドウ状態の特殊性**
   - スクリーンセーバーが特殊なウィンドウ状態（フルスクリーン、最前面など）を使用
   - 通常のウィンドウタイトル取得方法では空になる
   
3. **タイミング問題**
   - スクリーンセーバーの起動直後や終了直前で検出が不安定
   
4. **権限やセキュリティ問題**
   - Windows 10/11のセキュリティ設定により、スクリーンセーバープロセスへのアクセスが制限されている

## 調査計画

### 1. 既存のデバッグ機能の拡張

現在のデバッグ出力に加えて、以下の情報を追加:

- ウィンドウの実行可能ファイルパス（プロセス名）
- ウィンドウスタイル（WS_VISIBLEなど）
- ウィンドウの親子関係
- Z-order（ウィンドウの重なり順序）
- フルスクリーン状態の検出

### 2. 代替検出方法の実装

以下の追加検出方法を試験的に実装:

- プロセス名による検出（`.scr`拡張子のプロセス）
- ウィンドウサイズがスクリーンサイズと一致するかチェック
- ユーザーのアイドル時間のチェック
- Desktop Window Manager (DWM) APIの利用

### 3. テストケースの拡充

- 様々なスクリーンセーバータイプのモック
- 検出失敗パターンのテスト
- PowerShellフォールバックのテスト強化

## 実装方針

最小限の変更で最大の効果を得るため、以下の順序で実装:

1. デバッグ出力の拡張（プロセス情報の追加）
2. プロセス名による検出の追加（`.scr`ファイル）
3. 既存の検出方法との組み合わせ
4. テストの追加・更新

## 期待される成果

- スクリーンセーバー検出率の向上
- デバッグ情報による問題診断の容易化
- ユーザーが自分の環境で問題を特定できる情報の提供
