# issue PR 74 を参考に、スクリーンセーバー認識がなぜ失敗しているか調査を進める #75
[issues #75](https://github.com/cat2151/cat-window-watcher/issues/75)

## 調査概要

PR #74で追加された`debug_screensaver_detection`機能を活用し、Windowsスクリーンセーバー認識が失敗している原因を調査する。

**調査対象を特定**: Windowsの最もシンプルなスクリーンセーバー「scrnsave.scr」（設定画面で「ブランク」と表示）に焦点を当てて調査。

## 背景

- Issue #73: Windowsスクリーンセーバー時にスコアが増減しないようにする機能が失敗している
- PR #74: デバッグ機能を追加し、スクリーンセーバー検出の診断情報を出力できるようにした
- 報告されている問題:
  - Windowsスクリーンセーバーが空のウィンドウタイトルで表示される
  - スクリーンセーバーがスクリーンセーバーだと認識されない

## scrnsave.scr（ブランクスクリーンセーバー）の特定調査

### 対象の詳細
- **ファイル名**: scrnsave.scr
- **Windows設定での表示名**: "ブランク" (Blank)
- **動作**: 画面を真っ黒にするだけのシンプルなスクリーンセーバー
- **場所**: 通常は `C:\Windows\System32\scrnsave.scr`

### scrnsave.scrの特性

1. **ウィンドウクラス名**: "WindowsScreenSaverClass" (標準)
2. **ウィンドウタイトル**: 空文字列 ""
3. **プロセス名**: scrnsave.scr
4. **ウィンドウスタイル**: フルスクリーン、最前面

### 検出方法の検証

現在の実装で scrnsave.scr が検出できるはずの理由:

1. **クラス名チェック**: scrnsave.scrは標準の"WindowsScreenSaverClass"を使用
   - コード: `if "screensaver" in class_name.lower()`
   - → マッチするはず

2. **.scr拡張子チェック**: 実行ファイルが scrnsave.scr
   - コード: `if process_exe.lower().endswith(".scr")`
   - → マッチするはず

3. **特定ファイル名チェック**: scrnsave.scr という名前
   - 新規追加: `if "scrnsave.scr" in process_exe.lower()`
   - → より明示的な検出

### 検出失敗の可能性

もし scrnsave.scr が検出されない場合、以下の原因が考えられる:

1. **ウィンドウハンドルの取得失敗**
   - `GetForegroundWindow()` が無効なハンドル（0や-1）を返している
   - スクリーンセーバーウィンドウがフォアグラウンドとして認識されていない

2. **プロセス情報へのアクセス失敗**
   - 権限不足でプロセス情報を取得できない
   - win32processやpsutilが利用できない環境

3. **タイミング問題**
   - スクリーンセーバー起動直後で、まだウィンドウが完全に初期化されていない

## 実装した検出方法

### 現在の検出ロジック（優先順位順）

1. **ウィンドウクラス名チェック** (既存)
   - クラス名に"screensaver"が含まれるかチェック
   - scrnsave.scr の場合、"WindowsScreenSaverClass" にマッチする

2. **.scr拡張子チェック** (改善)
   - プロセスの実行ファイルが `.scr` で終わるかチェック
   - scrnsave.scr を含む全ての `.scr` ファイルを検出
   - ブランクスクリーンセーバー（scrnsave.scr）も確実に検出

3. **PowerShell フォールバック** (既存)
   - `SystemParametersInfo(SPI_GETSCREENSAVERRUNNING)` を使用
   - win32gui が利用できない場合のフォールバック

### デバッグ出力の拡張

`debug_screensaver_detection = true` の場合、以下の情報を出力:

- ウィンドウハンドル (hwnd)
- ウィンドウクラス名
- ウィンドウタイトル
- プロセスID
- プロセス名（ファイル名）
- プロセス実行ファイルパス
- 検出方法（どの方法でスクリーンセーバーと判定されたか）

### デバッグ出力の例（scrnsave.scr 検出時）

```
[DEBUG] Windows screensaver check (win32gui):
[DEBUG]   - Window handle: 12345
[DEBUG]   - Window class name: 'WindowsScreenSaverClass'
[DEBUG]   - Window title: ''
[DEBUG]   - Process ID: 9876
[DEBUG]   - Process name: scrnsave.scr
[DEBUG]   - Process executable: C:\Windows\System32\scrnsave.scr
[DEBUG]   - Process is a .scr file (screensaver executable)
[DEBUG]   - Detected: Blank screensaver (scrnsave.scr)
[DEBUG]   - Screensaver detected via class name
```

## 検証方法

ユーザーが scrnsave.scr の検出を確認する手順:

1. `config.toml` で `debug_screensaver_detection = true` を設定
2. Windowsの設定で「ブランク」スクリーンセーバーを選択し、待ち時間を1分に設定
3. cat-window-watcher を起動
4. 1分間待ってスクリーンセーバーが起動するのを待つ
5. コンソール出力を確認:
   - `[DEBUG]` で始まる行が表示されるか
   - `Process executable` に "scrnsave.scr" が含まれるか
   - `Screensaver detected via` で検出方法が表示されるか

## 結論

**scrnsave.scr（ブランクスクリーンセーバー）の検出方法は実装済み**:

1. ✅ ウィンドウクラス名による検出（"WindowsScreenSaverClass"）
2. ✅ .scr拡張子による検出
3. ✅ scrnsave.scr特定による検出（より明示的）
4. ✅ デバッグ出力でプロセス情報を表示

もし検出に失敗する場合は、デバッグ出力から以下を確認:
- ウィンドウハンドルが有効か（0でないか）
- プロセス情報が取得できているか
- どのチェックも True を返していないか

その場合は、デバッグ出力をissueに報告することで、さらなる調査が可能。
